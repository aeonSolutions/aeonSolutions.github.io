<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  

  <title>Exploring Sales Data</title>
  <meta name="description" content="<strong>A big part of the interview process for many data science positions is a
data science task or assignment. Companies usually choose a data set that is
typical for them, while only in rare cases a sample of their actual production
data. Here, I am exploring such a data set, sent out by a leading UK retailer.</strong>

">
  <meta name="author" content="Laurens Geffert">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Exploring Sales Data">
  <meta name="twitter:description" content="<strong>A big part of the interview process for many data science positions is a
data science task or assignment. Companies usually choose a data set that is
typical for them, while only in rare cases a sample of their actual production
data. Here, I am exploring such a data set, sent out by a leading UK retailer.</strong>

">
  
  <meta name="twitter:creator" content="JanLauGe">
  
  <meta name="twitter:image" content="/images/favicons/favicon-194x194.png" />

  <meta property="og:type" content="article">
  <meta property="og:title" content="Exploring Sales Data">
  <meta property="og:description" content="<strong>A big part of the interview process for many data science positions is a
data science task or assignment. Companies usually choose a data set that is
typical for them, while only in rare cases a sample of their actual production
data. Here, I am exploring such a data set, sent out by a leading UK retailer.</strong>

">
  <meta property="og:image" content="/images/favicons/favicon-194x194.png" />

  <link rel="apple-touch-icon" sizes="57x57" href="images/favicons/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="images/favicons/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="images/favicons/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="images/favicons/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="images/favicons/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="images/favicons/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="images/favicons/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="images/favicons/apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="images/favicons/apple-touch-icon-180x180.png">
  <link rel="icon" type="image/png" href="images/favicons/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="images/favicons/favicon-194x194.png" sizes="194x194">
  <link rel="icon" type="image/png" href="images/favicons/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="images/favicons/android-chrome-192x192.png" sizes="192x192">
  <link rel="icon" type="image/png" href="images/favicons/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="images/favicons/manifest.json">
  <link rel="shortcut icon" href="images/favicons/favicon.ico">
  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link rel="stylesheet" href="css/main.css?1539431935741611000">
  <link rel="canonical" href="http://localhost:4000/2017/exploring-sales-data/">
  <link rel="alternate" type="application/rss+xml" title="Laurens Geffert" href="feed.xml">
</head>


  <body>
    <span class="mobile btn-mobile-menu">
  <i class="icon icon-list btn-mobile-menu__icon"></i>
  <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
</span>

<header class="panel-cover" style="background-image: url(images/cover.jpg)">
  <div class="panel-main">

    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">
        <a href="" title="link to home of Laurens Geffert">
          <img src="images/profile.png" class="user-image" alt="My Profile Photo">
          <h1 class="panel-cover__title panel-title">Laurens Geffert</h1>
        </a>
        <hr class="panel-cover__divider">
        <p class="panel-cover__description">Data Science Portfolio</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary">

        <div class="navigation-wrapper">

          <nav class="cover-navigation cover-navigation--primary">

      		  <!-- Blog Button -->
      		  <ul class="navigation">
      			  <li class="navigation__item"><a href="/index" title="Blog posts" class="blog-button">Blog</a></li>
      		  </ul>

      		  <!-- About Button -->
      		  <ul class="navigation">
      			  <li class="navigation__item"><a href="/about" title="About the author" class="blog-button">About</a></li>
      		  </ul>

      		  <!-- Blog Roll -->
      		  <ul class="navigation">
      			  <li class="navigation__item"><a href="/links" title="Links to other sites" class="blog-button">Links</a></li>
      		  </ul>

          </nav>

          <nav class="cover-navigation navigation--social">
            <ul class="navigation">

              
                <!-- GitHub -->
                <li class="navigation__item">
                  <a href="https://www.github.com/JanLauGe" title="JanLauGe on GitHub" target="_blank">
                    <i class="icon icon-social-github"></i>
                    <span class="label">GitHub</span>
                  </a>
                </li>
              

  			      
                <!-- Twitter -->
                <li class="navigation__item">
                  <a href="http://twitter.com/JanLauGe" title="@JanLauGe on Twitter" target="_blank">
                    <i class="icon icon-social-twitter"></i>
                    <span class="label">Twitter</span>
                  </a>
                </li>
              

              
                <!-- LinkedIn -->
                <li class="navigation__item">
                  <a href="https://www.linkedin.com/in/laurensgeffert" title="laurensgeffert on LinkedIn" target="_blank">
                    <i class="icon icon-social-linkedin"></i>
                    <span class="label">LinkedIn</span>
                  </a>
                </li>
              

        			
        			  <!-- Stackoverflow -->
        			  <li class="navigation__item">
        				  <a href="https://stackoverflow.com/users/5457259/janlauge" title="janlauge on StackOverflow" target="_blank">
        				    <i class="icon icon-social-stack-overflow"></i>
        				    <span class="label">Stackoverflow</span>
        				  </a>
        			  </li>
              

              
        			  <!-- Kaggle -->
        			  <li class="navigation__item">
        				  <a href="https://www.kaggle.com/janlauge" title="janlauge on Kaggle" target="_blank">
        				    <i class="icon icon-trophy"></i>
        				    <span class="label">Kaggle</span>
        				  </a>
        			  </li>
              

        			
        			  <!-- Googlescholar -->
        			  <li class="navigation__item">
                  <a href="https://scholar.google.co.uk/citations?user=_aqDDYYAAAAJ&hl=en" title="Laurens Geffert on Google Scholar" target="_blank">
                    <i class="icon icon-social-google-plus"></i>
                    <span class="label">Google Scholar</span>
                  </a>
                </li>
              

              

              
                <!-- Email -->
                <li class="navigation__item">
                  <a href="mailto:laurensgeffert@gmail.com" title="Email laurensgeffert@gmail.com" target="_blank">
                    <i class="icon icon-mail"></i>
                    <span class="label">Email</span>
                  </a>
                </li>
              

              <!-- RSS -->
              <li class="navigation__item">
                <a href="feed.xml" title="Subscribe" target="_blank">
                  <i class="icon icon-rss"></i>
                  <span class="label">RSS</span>
                </a>
              </li>

            </ul>
          </nav>

        </div>

      </div>

    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>


    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <article class="post-container post-container--single">
  <header class="post-header">
    <div class="post-meta">
      <time datetime="1 Oct 2017" class="post-meta__date date">1 Oct 2017</time>
      
      &#8226; <span class="post-meta__tags">on <a href="tags/#DataScience">DataScience</a> <a href="tags/#Recruiting">Recruiting</a> <a href="tags/#R">R</a> </span>
      
    </div>
    <h1 class="post-title">Exploring Sales Data</h1>
  </header>

  <section class="post">
    <p><strong>A big part of the interview process for many data science positions is a
data science task or assignment. Companies usually choose a data set that is
typical for them, while only in rare cases a sample of their actual production
data. Here, I am exploring such a data set, sent out by a leading UK retailer.</strong>
<!--more--></p>

<h2 id="the-task">The task</h2>
<p><em>Your task is to read all data into your preferred software environment, get an understanding of the various
variables that are included, and clean the dataset. Subsequently, proceed to build a model of your choice to
predict store sales in the test dataset. You can choose as many methods of evaluating the model.</em></p>

<h3 id="data-preparation">Data Preparation</h3>
<p>We’ll start by reading the data into R and having a look at the basic structure and variables available. Three tables are supplied: stores, train, and test. Since train and test are in the same format, we will combine the two tables in one (called ‘days’) to make reformatting a little easier.</p>

<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Any good R-script should use these ;)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">plyr</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">tidyr</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">magrittr</span><span class="p">)</span><span class="w">

</span><span class="n">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">gridExtra</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">ggthemes</span><span class="p">)</span><span class="w">

</span><span class="n">library</span><span class="p">(</span><span class="n">caret</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">glmnet</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">doMC</span><span class="p">)</span><span class="w">

</span><span class="c1"># Keep results reproducible</span><span class="w">
</span><span class="n">set.seed</span><span class="p">(</span><span class="m">1234</span><span class="p">)</span><span class="w">

</span><span class="c1"># Read the tabular data</span><span class="w">
</span><span class="n">stores</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.csv</span><span class="p">(</span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'original/store.csv'</span><span class="p">)</span><span class="w">
</span><span class="n">train</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.csv</span><span class="p">(</span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'original/train.csv'</span><span class="p">)</span><span class="w">
</span><span class="n">test</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.csv</span><span class="p">(</span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'original/test.csv'</span><span class="p">)</span><span class="w">
</span><span class="n">days</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rbind</span><span class="p">(</span><span class="w">
  </span><span class="n">cbind</span><span class="p">(</span><span class="n">train</span><span class="p">,</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'train'</span><span class="p">),</span><span class="w">
  </span><span class="n">cbind</span><span class="p">(</span><span class="n">test</span><span class="p">,</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'test'</span><span class="p">))</span><span class="w">

</span><span class="c1"># inspect the data</span><span class="w">
</span><span class="n">head</span><span class="p">(</span><span class="n">stores</span><span class="p">)</span><span class="w">
</span><span class="n">head</span><span class="p">(</span><span class="n">days</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p><strong>Put tables here</strong></p>

<p>Apparently, some of the categorical columns were interpreted as integers by R. We’ll fix that and reformat the data to make sure we use columns in an appropriate fashion. We also combine the data on days and shops are combined in one table via a left-hand join.</p>

<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Reformatting 'stores'</span><span class="w">
</span><span class="n">stores</span><span class="w"> </span><span class="o">%&lt;&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="w">
    </span><span class="c1"># Stores number as character</span><span class="w">
    </span><span class="n">Store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.character</span><span class="p">(</span><span class="n">Store</span><span class="p">),</span><span class="w">
    </span><span class="c1"># And CompetitionStart as combination of month and year</span><span class="w">
      </span><span class="n">CompetitionStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="w">
      </span><span class="c1"># Where CompetitionOpenSince values are NA</span><span class="w">
      </span><span class="c1"># we assume competition has been around for a while</span><span class="w">
      </span><span class="nf">is.na</span><span class="p">(</span><span class="n">CompetitionOpenSinceYear</span><span class="p">),</span><span class="w"> </span><span class="s1">'2000-01-01'</span><span class="p">,</span><span class="w">
      </span><span class="c1"># Otherwise we paste in month and year and make it a date (assuming 1st)</span><span class="w">
      </span><span class="n">paste0</span><span class="p">(</span><span class="s1">'01-'</span><span class="p">,</span><span class="w">
      </span><span class="n">CompetitionOpenSinceMonth</span><span class="p">,</span><span class="s1">'-'</span><span class="p">,</span><span class="w">
      </span><span class="n">CompetitionOpenSinceYear</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">as.Date</span><span class="p">(</span><span class="n">format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'%d-%m-%Y'</span><span class="p">))</span><span class="w">

</span><span class="c1"># Reformatting 'days'</span><span class="w">
</span><span class="c1"># Then we combine it with the shop data</span><span class="w">
</span><span class="n">days</span><span class="w"> </span><span class="o">%&lt;&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="w">
    </span><span class="c1"># Again, Stores as character</span><span class="w">
    </span><span class="n">Store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.character</span><span class="p">(</span><span class="n">Store</span><span class="p">),</span><span class="w">
    </span><span class="c1"># And date into a proper time stamp</span><span class="w">
    </span><span class="n">Date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as.Date</span><span class="p">(</span><span class="n">Date</span><span class="p">,</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'%d/%m/%Y'</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
</span><span class="c1"># Let's convert categorical information into factors</span><span class="w">
</span><span class="c1"># mutate_each(funs(as.factor), DayOfWeek) %&gt;%</span><span class="w">
  </span><span class="c1"># Bring in the shop data</span><span class="w">
  </span><span class="n">left_join</span><span class="p">(</span><span class="n">stores</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Store'</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="c1"># Any entries of 'CompetitionDistance' for days that predate</span><span class="w">
  </span><span class="c1"># 'CompetitionOpenSince...' are probably invalid. We'll replace them with</span><span class="w">
  </span><span class="c1"># the mean value of 'CompetitionDistance' across all stores</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">CompetitionDistance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="w">
    </span><span class="n">Date</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">CompetitionStart</span><span class="p">,</span><span class="w">
    </span><span class="n">mean</span><span class="p">(</span><span class="n">stores</span><span class="o">$</span><span class="n">CompetitionDistance</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),</span><span class="w">
    </span><span class="n">CompetitionDistance</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="c1"># Drop the old CompetitionOpenSince fields</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="o">-</span><span class="n">one_of</span><span class="p">(</span><span class="s1">'CompetitionOpenSinceMonth'</span><span class="p">,</span><span class="w"> </span><span class="s1">'CompetitionOpenSinceYear'</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>Now we can take an initial look at the data to better understand what we’ve got and how we can best put it to use in the modelling exercise. I will use a couple of basic questions to guide my exploration of the data set. Since there is no sales data for the hold-out partition of the data I excluded it from most of the plots in this section.</p>

<h3 id="which-stores-do-well">Which Stores do Well?</h3>

<p>We can look at the data on a sales-by-store level. Simply aggregate sales and other metrics from all days by store and plot them to visualise the relationship of metrics to one another. First, let’s try to understand what kind of shops are in our datasets. The shops are divided by their store type, and the range of products they offer (basic, medium, or full). The relationship between these factors is shown in the plot below.</p>

<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Make a data frame that aggregates the Sales data by Store</span><span class="w">
</span><span class="c1"># (Sales by Store, SbS)</span><span class="w">
</span><span class="n">SbS</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">days</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="c1"># Use only the train data</span><span class="w">
  </span><span class="n">filter</span><span class="p">(</span><span class="n">set</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">'train'</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">group_by</span><span class="p">(</span><span class="n">Store</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="c1"># Aggregate data by Store</span><span class="w">
  </span><span class="n">summarise</span><span class="p">(</span><span class="w">
    </span><span class="n">meanSales</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">Sales</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),</span><span class="w">
    </span><span class="n">meanCustomers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">Customers</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),</span><span class="w">
    </span><span class="n">totalSales</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">Sales</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),</span><span class="w">
    </span><span class="n">totalCustomers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">Customers</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),</span><span class="w">
    </span><span class="n">daysOpen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">Open</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),</span><span class="w">
    </span><span class="n">daysPromo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">Promo</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),</span><span class="w">
    </span><span class="n">daysHoliday</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">ifelse</span><span class="p">(</span><span class="n">StateHoliday</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">),</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),</span><span class="w">
    </span><span class="n">daysSchoolHoliday</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">SchoolHoliday</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),</span><span class="w">
    </span><span class="n">dailySales</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">totalSales</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">daysOpen</span><span class="p">,</span><span class="w">
    </span><span class="n">dailyCustomers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">totalCustomers</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">daysOpen</span><span class="p">,</span><span class="w">
    </span><span class="n">storeType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">first</span><span class="p">(</span><span class="n">StoreType</span><span class="p">),</span><span class="w">
    </span><span class="n">range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">first</span><span class="p">(</span><span class="n">Range</span><span class="p">),</span><span class="w">
    </span><span class="n">competitionDistance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">CompetitionDistance</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="c1"># Change the factor levels for nice labels</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="w">
    </span><span class="n">range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">factor</span><span class="p">(</span><span class="n">range</span><span class="p">,</span><span class="w"> </span><span class="n">labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'basic'</span><span class="p">,</span><span class="s1">'medium'</span><span class="p">,</span><span class="s1">'full'</span><span class="p">)),</span><span class="w">
    </span><span class="n">storeType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">factor</span><span class="p">(</span><span class="n">storeType</span><span class="p">,</span><span class="w"> </span><span class="n">labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'small'</span><span class="p">,</span><span class="s1">'medium'</span><span class="p">,</span><span class="s1">'big'</span><span class="p">,</span><span class="s1">'huge'</span><span class="p">)))</span><span class="w">

</span><span class="c1"># With the combined dataset, let's try and understand the shops data first</span><span class="w">
</span><span class="n">mosaicplot</span><span class="p">(</span><span class="w">
  </span><span class="n">storeType</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">range</span><span class="p">,</span><span class="w">
  </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SbS</span><span class="p">,</span><span class="w">
  </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Figure 1: Store type and range of products'</span><span class="p">,</span><span class="w">
  </span><span class="n">xlab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Store type'</span><span class="p">,</span><span class="w">
  </span><span class="n">ylab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Range of Products'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><img src="http://localhost:4000/assets/sales_analysis_plot_1.jpg" alt="Store type and range of products" /></p>

<p>We can see that there is a large number of small shops but only very few medium ones. Another noticeable factor is that barely any shops offer the medium product range. All of those that do fall in the medium size shop type. Furthermore, small shops are more likely to only offer the basic product range, while big and huge shops are more likely to offer the full range of products. However, a number of big and huge shops restrict their product range to the basic selection, which seems surprising. Perhaps the store type does not represent an ordinal scale of shop size as initially assumed?</p>

<p>Next we will look at some of the continuous variables available for our shops. We can plot number of customers against daily sales and differentiate by store type:</p>

<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">SbS</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="w">
    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dailyCustomers</span><span class="p">,</span><span class="w">
    </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dailySales</span><span class="p">,</span><span class="w">
    </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">storeType</span><span class="p">,</span><span class="w">
    </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">range</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_point</span><span class="p">(</span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">ggtitle</span><span class="p">(</span><span class="s1">'Figure 2: Relationship of daily customers with daily sales'</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">xlab</span><span class="p">(</span><span class="s1">'Mean Daily Number of Customers'</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ylab</span><span class="p">(</span><span class="s1">'Mean Daily Sales'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><img src="http://localhost:4000/assets/sales_analysis_plot_2.jpg" alt="Relationship of daily customers with daily sales" /></p>

<p>Somewhat unsurprisingly, there seems to be a strong relationship between number of customers and sales. Interestingly tough, when splitting this data up by store inventory, both ‘basic range’ stores and ‘maximum range’ stores seem to be doing well (i.e. high sales per customer) while ‘medium range’ stores have lower sales per customer. Additionally, small shops seem to have more customers than big and huge shops. Another indicator that my assumption about the nature of the store type was wrong.</p>

<p>Now I will go back to the data by day. Let’s first look at the sales data by day of the week (Figure 3). We can see that sales are highest on Monday, drop a bit during the middle of the week, pick up slightly on Friday, are lower on Saturday and basically nonexistent on Sunday (most shops are closed). This suggests that the day of the week should be included as a predictor in our final model.
We can also use the dates to create time series for shops and look at the variation of sales over time. To take out weekly variability I also included a rolling mean of sales for a 7-day window (SalesOfWeek). The resulting plot (Figure 4) shows us the sales of the 2 years from the beginning of 2013 till the end of 2014. We can see patterns of regular variation in sales over the year. Here is what stands out to me:</p>
<ul>
  <li>Sales are low on Sundays (most shops are closed!)</li>
  <li>Promotions tend to be every other week</li>
  <li>Sales are higher in week with promotion</li>
  <li>Sales are slightly higher in the time before Easter and distinctly higher before Christmas</li>
</ul>

<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Sales by WeekDay</span><span class="w">
</span><span class="n">SbWD</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">days</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">filter</span><span class="p">(</span><span class="n">set</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">'train'</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="w">
    </span><span class="n">DateType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">paste0</span><span class="p">(</span><span class="n">StoreType</span><span class="p">,</span><span class="w"> </span><span class="s1">'-'</span><span class="p">,</span><span class="w"> </span><span class="n">Date</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">group_by</span><span class="p">(</span><span class="n">DateType</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">summarise</span><span class="p">(</span><span class="w">
    </span><span class="n">Sales</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">Sales</span><span class="p">),</span><span class="w">
    </span><span class="n">DayOfWeek</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="n">DayOfWeek</span><span class="p">),</span><span class="w">
    </span><span class="n">StateHoliday</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="n">ifelse</span><span class="p">(</span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">StateHoliday</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">)),</span><span class="w">
    </span><span class="n">SchoolHoliday</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="n">SchoolHoliday</span><span class="p">),</span><span class="w">
    </span><span class="n">Promo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">Promo</span><span class="p">),</span><span class="w">
    </span><span class="n">StoreType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">first</span><span class="p">(</span><span class="n">StoreType</span><span class="p">))</span><span class="w">
</span><span class="c1"># Plot sales per day of the week</span><span class="w">
</span><span class="n">SbWD</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="w">
    </span><span class="n">DayOfWeek</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">factor</span><span class="p">(</span><span class="w">
      </span><span class="n">DayOfWeek</span><span class="p">,</span><span class="w">
      </span><span class="n">labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'Mon'</span><span class="p">,</span><span class="s1">'Tue'</span><span class="p">,</span><span class="s1">'Wed'</span><span class="p">,</span><span class="s1">'Thu'</span><span class="p">,</span><span class="s1">'Fri'</span><span class="p">,</span><span class="s1">'Sat'</span><span class="p">,</span><span class="s1">'Sun'</span><span class="p">)))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">DayOfWeek</span><span class="p">,</span><span class="w"> </span><span class="n">Sales</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StoreType</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_boxplot</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ggtitle</span><span class="p">(</span><span class="s1">'Figure 3: Mean Sales per Day of the Week'</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">xlab</span><span class="p">(</span><span class="s1">'Day of the Week'</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ylab</span><span class="p">(</span><span class="s1">'Mean Sales'</span><span class="p">)</span><span class="w">


</span><span class="c1"># Time series of sales</span><span class="w">
</span><span class="c1"># (Sales by Day, SbD)</span><span class="w">
</span><span class="n">SbD</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">days</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">filter</span><span class="p">(</span><span class="n">set</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">'train'</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">group_by</span><span class="p">(</span><span class="n">Date</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">summarise</span><span class="p">(</span><span class="w">
    </span><span class="n">Sales</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">Sales</span><span class="p">),</span><span class="w">
    </span><span class="n">DayOfWeek</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">DayOfWeek</span><span class="p">)</span><span class="m">-1</span><span class="p">),</span><span class="w">
    </span><span class="n">StateHoliday</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="n">ifelse</span><span class="p">(</span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">StateHoliday</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">)),</span><span class="w">
    </span><span class="n">SchoolHoliday</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="n">SchoolHoliday</span><span class="p">),</span><span class="w">
    </span><span class="n">Promo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">Promo</span><span class="p">))</span><span class="w">
</span><span class="c1"># Get a rolling mean of Sales</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">RcppRoll</span><span class="p">)</span><span class="w">
</span><span class="n">SbD</span><span class="o">$</span><span class="n">SalesOfWeek</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">roll_mean</span><span class="p">(</span><span class="w">
      </span><span class="n">SbD</span><span class="o">$</span><span class="n">Sales</span><span class="p">,</span><span class="w">
      </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">7</span><span class="p">,</span><span class="w">
      </span><span class="n">align</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'center'</span><span class="p">,</span><span class="w">
      </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">SbD</span><span class="o">$</span><span class="n">Sales</span><span class="p">),</span><span class="w">
      </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
</span><span class="c1"># Timeline plot of sales data</span><span class="w">
</span><span class="n">SbD</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="w">
    </span><span class="c1"># Rescale some of the variables</span><span class="w">
    </span><span class="n">Sales</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sales</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">10000</span><span class="p">,</span><span class="w">
    </span><span class="n">SalesOfWeek</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SalesOfWeek</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">10000</span><span class="p">,</span><span class="w">
    </span><span class="n">Promo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Promo</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">1000</span><span class="p">,</span><span class="w">
    </span><span class="n">DayOfWeek</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DayOfWeek</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">7</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">gather</span><span class="p">(</span><span class="w">
    </span><span class="c1"># Get data into long format for ggplot</span><span class="w">
    </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">category</span><span class="p">,</span><span class="w">
    </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">measurement</span><span class="p">,</span><span class="w">
    </span><span class="n">Sales</span><span class="p">,</span><span class="w"> </span><span class="n">SalesOfWeek</span><span class="p">,</span><span class="w"> </span><span class="n">DayOfWeek</span><span class="p">,</span><span class="w"> </span><span class="n">StateHoliday</span><span class="p">,</span><span class="w"> </span><span class="n">SchoolHoliday</span><span class="p">,</span><span class="w"> </span><span class="n">Promo</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="w">
    </span><span class="c1"># Change the order they will be plotted by</span><span class="w">
    </span><span class="n">category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">factor</span><span class="p">(</span><span class="w">
      </span><span class="n">category</span><span class="p">,</span><span class="w">
      </span><span class="n">levels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'Sales'</span><span class="p">,</span><span class="w">
                 </span><span class="s1">'SalesOfWeek'</span><span class="p">,</span><span class="w">
                 </span><span class="s1">'Promo'</span><span class="p">,</span><span class="w">
                 </span><span class="s1">'DayOfWeek'</span><span class="p">,</span><span class="w">
                 </span><span class="s1">'SchoolHoliday'</span><span class="p">,</span><span class="w">
                 </span><span class="s1">'StateHoliday'</span><span class="p">)))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="c1"># Make the plot</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">Date</span><span class="p">,</span><span class="w"> </span><span class="n">measurement</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">category</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_line</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">facet_grid</span><span class="p">(</span><span class="n">category</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">.</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">ggtitle</span><span class="p">(</span><span class="s1">'Figure 4: Time Series Representation of the Data'</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">ylab</span><span class="p">(</span><span class="s1">'Rescaled Variable Value'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<h2 id="modelling">Modelling</h2>

<p>For benchmarking I will create a very simple model: No data cleaning, no feature engineering, just the raw (reformatted) data in a GLMNET and GBM. I am using dummy variables for categorical variables and raw values for continuous variables. The model is evaluated with ten-fold cross-validation, repeated 5 times.</p>

<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Transforming factors into dummy variables</span><span class="w">
</span><span class="n">daysdummy</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">days</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">filter</span><span class="p">(</span><span class="n">set</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">'train'</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="n">one_of</span><span class="p">(</span><span class="s1">'DayOfWeek'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Promo'</span><span class="p">,</span><span class="w"> </span><span class="s1">'StateHoliday'</span><span class="p">,</span><span class="w">
    </span><span class="s1">'SchoolHoliday'</span><span class="p">,</span><span class="w"> </span><span class="s1">'StoreType'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Range'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Sales'</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="c1"># Create dummy variables</span><span class="w">
  </span><span class="n">model.matrix</span><span class="p">(</span><span class="n">Sales</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">.</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">.</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="c1"># Get the Sales data back</span><span class="w">
  </span><span class="n">cbind</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">days</span><span class="p">,</span><span class="w">
    </span><span class="o">-</span><span class="n">one_of</span><span class="p">(</span><span class="s1">'(Intercept)'</span><span class="p">,</span><span class="w"> </span><span class="s1">'DayOfWeek'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Promo'</span><span class="p">,</span><span class="w"> </span><span class="s1">'StateHoliday'</span><span class="p">,</span><span class="w">
      </span><span class="s1">'SchoolHoliday'</span><span class="p">,</span><span class="w"> </span><span class="s1">'StoreType'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Range'</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">filter</span><span class="p">(</span><span class="n">set</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">'train'</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="w">
    </span><span class="c1"># If CompetitionDistance is NA, use max Competition distance</span><span class="w">
    </span><span class="n">CompetitionDistance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="w">
      </span><span class="nf">is.na</span><span class="p">(</span><span class="n">CompetitionDistance</span><span class="p">),</span><span class="w">
      </span><span class="nf">max</span><span class="p">(</span><span class="n">days</span><span class="o">$</span><span class="n">CompetitionDistance</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),</span><span class="w">
      </span><span class="n">CompetitionDistance</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="c1"># Create simple training set treating each day as independent observation,</span><span class="w">
  </span><span class="c1"># ignoring factors Store and Date for now</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="o">-</span><span class="n">Store</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">Date</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">Open</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">set</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">CompetitionStart</span><span class="p">)</span><span class="w">

</span><span class="c1"># Inspect the variables</span><span class="w">
</span><span class="n">head</span><span class="p">(</span><span class="n">daysdummy</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<h3 id="glm">GLM</h3>

<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tuneControl</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">trainControl</span><span class="p">(</span><span class="w">
 </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"repeatedcv"</span><span class="p">,</span><span class="w">
 </span><span class="n">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w">
 </span><span class="n">repeats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span><span class="p">)</span><span class="w">
</span><span class="n">model1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">train</span><span class="p">(</span><span class="w">
 </span><span class="n">Sales</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">.</span><span class="p">,</span><span class="w">
 </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">daysdummy</span><span class="p">,</span><span class="w">
 </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'glmnet'</span><span class="p">,</span><span class="w">
 </span><span class="n">metric</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'RMSE'</span><span class="p">,</span><span class="w">
 </span><span class="n">trControl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tuneControl</span><span class="p">)</span><span class="w">

</span><span class="n">model1</span><span class="w">
</span></code></pre></div></div>

<blockquote>
  <p>glmnet</p>

  <p>780829 samples
    19 predictor</p>

  <p>No pre-processing
Resampling: Cross-Validated (10 fold, repeated 5 times)
Summary of sample sizes: 702746, 702747, 702746, 702747, 702746, 702747, …
Resampling results across tuning parameters:</p>

  <p>alpha  lambda     RMSE      Rsquared
  0.10     6.91422  1210.331  0.9013087
  0.10    69.14220  1214.036  0.9009795
  0.10   691.42198  1386.398  0.8870391
  0.55     6.91422  1210.402  0.9012853
  0.55    69.14220  1228.537  0.8988403
  0.55   691.42198  1611.039  0.8521414
  1.00     6.91422  1211.024  0.9011885
  1.00    69.14220  1245.152  0.8963104
  1.00   691.42198  1754.444  0.8288464</p>

  <p>RMSE was used to select the optimal model using  the smallest value.
The final values used for the model were alpha = 0.1 and lambda = 6.91422.</p>
</blockquote>

<h3 id="gbm">GBM</h3>

<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fitControl</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">trainControl</span><span class="p">(</span><span class="w">
  </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"repeatedcv"</span><span class="p">,</span><span class="w">
  </span><span class="n">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w">
  </span><span class="n">repeats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span><span class="p">)</span><span class="w">
</span><span class="n">model2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">train</span><span class="p">(</span><span class="w">
  </span><span class="n">Sales</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">.</span><span class="p">,</span><span class="w">
  </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">daysdummy</span><span class="p">,</span><span class="w">
  </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"gbm"</span><span class="p">,</span><span class="w">
  </span><span class="n">trControl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fitControl</span><span class="p">)</span><span class="w">
</span><span class="n">save</span><span class="p">(</span><span class="n">model2</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'saved/basic.gbm.rda'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<blockquote>
  <p>Stochastic Gradient Boosting</p>

  <p>780829 samples
    19 predictor</p>

  <p>No pre-processing
Resampling: Cross-Validated (10 fold, repeated 5 times)
Summary of sample sizes: 702746, 702746, 702745, 702746, 702747, 702747, …
Resampling results across tuning parameters:</p>

  <p>interaction.depth  n.trees  RMSE      Rsquared
  1                   50      1502.452  0.8639662
  1                  100      1296.930  0.8922199
  1                  150      1225.590  0.9011660
  2                   50      1287.706  0.8954673
  2                  100      1138.885  0.9137963
  2                  150      1101.484  0.9186211
  3                   50      1193.371  0.9078775
  3                  100      1090.395  0.9202973
  3                  150      1063.971  0.9238807</p>

  <p>Tuning parameter ‘shrinkage’ was held constant at a value of 0.1
Tuning parameter ‘n.minobsinnode’ was held constant at a value of 10
RMSE was used to select the optimal model using the smallest value.
The final values used for the model were n.trees = 150,
interaction.depth = 3, shrinkage = 0.1 and n.minobsinnode = 10.</p>
</blockquote>

<p>Now, let’s see how we can improve the above predictions. I feel like I have a better understanding now of how sales behave between stores and over time, so I will try creating some features from what we have learned in the data exploration. I create a variable indicating days before Christmas and Easter, to incorporate the lag between the holiday and the impact on people’s shopping behaviour. I also calculate mean sales per store and include this values into the set of predictors, which acts as a proxy for the population density, infrastructure availability, and similar factors related to the location of each individual store. Finally, I exclude closed days here. Predicting closed days as 0 would decrease the error metric, but that feels like cheating! Instead, let’s only look at days that the shops are open.</p>

<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Include mean sales by store as predictor</span><span class="w">
</span><span class="n">meanSbS</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">days</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">left_join</span><span class="p">(</span><span class="w">
    </span><span class="n">select</span><span class="p">(</span><span class="n">SbS</span><span class="p">,</span><span class="w"> </span><span class="n">one_of</span><span class="p">(</span><span class="s1">'Store'</span><span class="p">,</span><span class="w"> </span><span class="s1">'meanSales'</span><span class="p">)),</span><span class="w">
    </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Store'</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">group_by</span><span class="p">(</span><span class="n">Store</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">summarise</span><span class="p">(</span><span class="w">
    </span><span class="n">meanSales</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">Sales</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">))</span><span class="w">

</span><span class="c1"># Include days before christmas and easter as predictor</span><span class="w">
</span><span class="n">daysBH</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">days</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="w">
    </span><span class="n">Easter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">StateHoliday</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">'b'</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">),</span><span class="w">
    </span><span class="n">Christmas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">StateHoliday</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">'c'</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">),</span><span class="w">
    </span><span class="n">StateHoliday</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">StateHoliday</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">'0'</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">group_by</span><span class="p">(</span><span class="n">Date</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">summarise</span><span class="p">(</span><span class="w">
    </span><span class="n">StateHoliday</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="n">StateHoliday</span><span class="p">),</span><span class="w">
    </span><span class="n">Christmas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="n">Christmas</span><span class="p">),</span><span class="w">
    </span><span class="n">Easter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="n">Easter</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="w">
    </span><span class="n">BH</span><span class="w"> </span><span class="o">=</span><span class="w">
      </span><span class="n">lead</span><span class="p">(</span><span class="n">StateHoliday</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="o">+</span><span class="w">
      </span><span class="n">lead</span><span class="p">(</span><span class="n">StateHoliday</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="o">+</span><span class="w">
      </span><span class="n">lead</span><span class="p">(</span><span class="n">StateHoliday</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">),</span><span class="w">
    </span><span class="n">BC</span><span class="w"> </span><span class="o">=</span><span class="w">
      </span><span class="n">lead</span><span class="p">(</span><span class="n">Christmas</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="o">+</span><span class="w">
      </span><span class="n">lead</span><span class="p">(</span><span class="n">Christmas</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="o">+</span><span class="w">
      </span><span class="n">lead</span><span class="p">(</span><span class="n">Christmas</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">),</span><span class="w">
    </span><span class="n">BE</span><span class="w"> </span><span class="o">=</span><span class="w">
      </span><span class="n">lead</span><span class="p">(</span><span class="n">Easter</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="o">+</span><span class="w">
      </span><span class="n">lead</span><span class="p">(</span><span class="n">Easter</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="o">+</span><span class="w">
      </span><span class="n">lead</span><span class="p">(</span><span class="n">Easter</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="n">Date</span><span class="p">,</span><span class="w"> </span><span class="n">BH</span><span class="p">,</span><span class="w"> </span><span class="n">BC</span><span class="p">,</span><span class="w"> </span><span class="n">BE</span><span class="p">)</span><span class="w">

</span><span class="c1"># Add it all together</span><span class="w">
</span><span class="n">modeldata</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">days</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">left_join</span><span class="p">(</span><span class="w">
    </span><span class="n">meanSbS</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Store'</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">left_join</span><span class="p">(</span><span class="w">
    </span><span class="n">daysBH</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Date'</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="w">
    </span><span class="c1"># If CompetitionDistance is NA, use max Competition distance</span><span class="w">
    </span><span class="n">CompetitionDistance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="w">
      </span><span class="nf">is.na</span><span class="p">(</span><span class="n">CompetitionDistance</span><span class="p">),</span><span class="w">
      </span><span class="nf">max</span><span class="p">(</span><span class="n">days</span><span class="o">$</span><span class="n">CompetitionDistance</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),</span><span class="w">
      </span><span class="n">CompetitionDistance</span><span class="p">),</span><span class="w">
    </span><span class="c1"># If any holiday lag is NA, use zero</span><span class="w">
    </span><span class="n">BH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">BH</span><span class="p">),</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">BH</span><span class="p">),</span><span class="w">
    </span><span class="n">BC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">BH</span><span class="p">),</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">BC</span><span class="p">),</span><span class="w">
    </span><span class="n">BE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">BE</span><span class="p">),</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">BE</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="o">-</span><span class="n">CompetitionStart</span><span class="p">)</span><span class="w">

</span><span class="c1"># Transforming factors into dummy variables</span><span class="w">
</span><span class="n">modeldata</span><span class="w"> </span><span class="o">%&lt;&gt;%</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="n">one_of</span><span class="p">(</span><span class="s1">'DayOfWeek'</span><span class="p">,</span><span class="w"> </span><span class="s1">'StoreType'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Range'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Sales'</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="w">
    </span><span class="c1"># Dummy value to include test set in transformation</span><span class="w">
    </span><span class="n">Sales</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">Sales</span><span class="p">),</span><span class="w"> </span><span class="m">-999</span><span class="p">,</span><span class="w"> </span><span class="n">Sales</span><span class="p">),</span><span class="w">
    </span><span class="n">DayOfWeek</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as.factor</span><span class="p">(</span><span class="n">DayOfWeek</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="c1"># Create dummy variables</span><span class="w">
  </span><span class="n">model.matrix</span><span class="p">(</span><span class="n">Sales</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">.</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">.</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="c1"># Get the Sales data back</span><span class="w">
  </span><span class="n">cbind</span><span class="p">(</span><span class="n">modeldata</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="w">
    </span><span class="n">StateHoliday</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">StateHoliday</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="w">
    </span><span class="o">-</span><span class="n">one_of</span><span class="p">(</span><span class="s1">'(Intercept)'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Store'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Date'</span><span class="p">,</span><span class="w">
            </span><span class="s1">'DayOfWeek'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Promo'</span><span class="p">,</span><span class="w"> </span><span class="s1">'StoreType'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Range'</span><span class="p">))</span><span class="w">

</span><span class="c1"># Select train and test data</span><span class="w">
</span><span class="n">trainset</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">filter</span><span class="p">(</span><span class="n">modeldata</span><span class="p">,</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">'train'</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Open</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="o">-</span><span class="n">Open</span><span class="p">,</span><span class="w"> </span><span class="n">set</span><span class="p">)</span><span class="w">
</span><span class="n">testset</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">filter</span><span class="p">(</span><span class="n">modeldata</span><span class="p">,</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">'test'</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Open</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="o">-</span><span class="n">Open</span><span class="p">,</span><span class="w"> </span><span class="n">set</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>From the previous quick tuning runs, we know that the GBM did much better than the GLM. I suspect that this is due to the interaction between variables which the GBM is able to capture while the GLM (with the formula I use) only looks at variables by themselves. We’ll, therefore, use the GBM model. Predictions from this model improved with higher interaction and a higher number of trees, so I will choose some higher values here. I would have liked to do more parameter tuning on this, but the model takes quite a while to compute so I’ll do with these ad-hoc values (if you are rerunning the code, avoid rerunning this bit and load the saved model object instead).</p>

<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">registerDoMC</span><span class="p">(</span><span class="n">cores</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="p">)</span><span class="w">

</span><span class="n">fitControl</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">trainControl</span><span class="p">(</span><span class="w">
 </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"repeatedcv"</span><span class="p">,</span><span class="w">
 </span><span class="n">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w">
 </span><span class="n">repeats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w">
 </span><span class="n">allowParallel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w">
 </span><span class="n">verboseIter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
</span><span class="n">gbmGrid</span><span class="w"> </span><span class="o">&lt;-</span><span class="w">  </span><span class="n">expand.grid</span><span class="p">(</span><span class="w">
 </span><span class="n">interaction.depth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w">
 </span><span class="n">n.trees</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">500</span><span class="p">,</span><span class="w">
 </span><span class="n">shrinkage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.2</span><span class="p">,</span><span class="w">
 </span><span class="n">n.minobsinnode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="p">)</span><span class="w">
</span><span class="n">model4</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">train</span><span class="p">(</span><span class="w">
 </span><span class="n">Sales</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">.</span><span class="p">,</span><span class="w">
 </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trainset</span><span class="p">,</span><span class="w">
 </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"gbm"</span><span class="p">,</span><span class="w">
 </span><span class="n">tuneGrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gbmGrid</span><span class="p">,</span><span class="w">
 </span><span class="n">trControl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fitControl</span><span class="p">)</span><span class="w">

</span><span class="c1"># Predict in-sample</span><span class="w">
</span><span class="n">is.prediction</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">model4</span><span class="p">,</span><span class="w"> </span><span class="n">newdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trainset</span><span class="p">)</span><span class="w">
</span><span class="n">os.prediction</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">model4</span><span class="p">,</span><span class="w"> </span><span class="n">newdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">testset</span><span class="p">)</span><span class="w">

</span><span class="c1"># Predict with closed days</span><span class="w">
</span><span class="n">fs.prediction</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">model4</span><span class="p">,</span><span class="w">
  </span><span class="n">newdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">modeldata</span><span class="p">,</span><span class="w">
  </span><span class="n">na.action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">na.pass</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="c1"># Create data frame with predictions</span><span class="w">
  </span><span class="c1"># Use prediction for both train and test set</span><span class="w">
  </span><span class="n">cbind</span><span class="p">(</span><span class="s1">'Prediction'</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">.</span><span class="p">,</span><span class="w"> </span><span class="n">days</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="c1"># Set closed days to zero</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">Prediction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">Open</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">Prediction</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="c1"># Set negative values to zero</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">Prediction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">Prediction</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">Prediction</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>We have a set of predictions now, but I don’t have the Sales values for 2015 so I can’t evaluate on the blind holdout sample. Instead, I will plot the results for visual inspection.</p>

<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Simple scatterplot to see the results</span><span class="w">
</span><span class="n">fs.prediction</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
</span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">Sales</span><span class="p">,</span><span class="w"> </span><span class="n">Prediction</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_point</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ylab</span><span class="p">(</span><span class="s1">'Predicted Sales'</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">ggtitle</span><span class="p">(</span><span class="s1">'Simple Scatterplot of observed and predicted sales'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>The scatterplot reveals that for the training set there is a very good agreement between the observed and predicted sales, indicated by the long, linear shape of the point cloud. For some values, the model underestimates the values of sales, so it seems that my model is missing out on a part of the signal here. Further research could go into what distinguishes these points from the rest of the data set. When plotting the time series again, it seems that the general trend in the sales data is well captured. The range of variation in the weekly sales data, however, also seems to be slightly underestimated by the model.</p>

<p><img src="http://localhost:4000/assets/sales_analysis_plot_4.jpg" alt="Observed and predicted sales" /></p>

<p>Let’s plot the time series again, this time including both the train and the test period.</p>

<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ts.prediction</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">fs.prediction</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">group_by</span><span class="p">(</span><span class="n">Date</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">summarise</span><span class="p">(</span><span class="w">
    </span><span class="n">Sales</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">Sales</span><span class="p">),</span><span class="w">
    </span><span class="n">Prediction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">Prediction</span><span class="p">))</span><span class="w">

</span><span class="n">ts.prediction</span><span class="o">$</span><span class="n">SalesOfWeek</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">roll_mean</span><span class="p">(</span><span class="w">
      </span><span class="n">ts.prediction</span><span class="o">$</span><span class="n">Sales</span><span class="p">,</span><span class="w">
      </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">7</span><span class="p">,</span><span class="w">
      </span><span class="n">align</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'center'</span><span class="p">,</span><span class="w">
      </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">ts.prediction</span><span class="o">$</span><span class="n">Sales</span><span class="p">),</span><span class="w">
      </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
</span><span class="n">ts.prediction</span><span class="o">$</span><span class="n">PredictionOfWeek</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">roll_mean</span><span class="p">(</span><span class="w">
      </span><span class="n">ts.prediction</span><span class="o">$</span><span class="n">Prediction</span><span class="p">,</span><span class="w">
      </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">7</span><span class="p">,</span><span class="w">
      </span><span class="n">align</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'center'</span><span class="p">,</span><span class="w">
      </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">ts.prediction</span><span class="o">$</span><span class="n">Sales</span><span class="p">),</span><span class="w">
      </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
</span><span class="c1"># Timeline plot of sales data</span><span class="w">
</span><span class="n">ts.prediction</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">gather</span><span class="p">(</span><span class="w">
    </span><span class="c1"># Get data into long format for ggplot</span><span class="w">
    </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">category</span><span class="p">,</span><span class="w">
    </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">measurement</span><span class="p">,</span><span class="w">
    </span><span class="n">Sales</span><span class="p">,</span><span class="w"> </span><span class="n">SalesOfWeek</span><span class="p">,</span><span class="w"> </span><span class="n">Prediction</span><span class="p">,</span><span class="w"> </span><span class="n">PredictionOfWeek</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="w">
    </span><span class="c1"># Change the order they will be plotted by</span><span class="w">
    </span><span class="n">category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">factor</span><span class="p">(</span><span class="w">
      </span><span class="n">category</span><span class="p">,</span><span class="w">
      </span><span class="n">levels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'Sales'</span><span class="p">,</span><span class="w">
                 </span><span class="s1">'SalesOfWeek'</span><span class="p">,</span><span class="w">
                 </span><span class="s1">'Prediction'</span><span class="p">,</span><span class="w">
                 </span><span class="s1">'PredictionOfWeek'</span><span class="p">)))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="c1"># Make the plot</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">Date</span><span class="p">,</span><span class="w"> </span><span class="n">measurement</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">category</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_line</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">facet_grid</span><span class="p">(</span><span class="n">category</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">.</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">ggtitle</span><span class="p">(</span><span class="s1">'Figure 6: Time Series Representation of the Data'</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">ylab</span><span class="p">(</span><span class="s1">'Variable Value'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><img src="http://localhost:4000/assets/sales_analysis_plot_5.jpg" alt="Time series plot of the full dataset" /></p>

<p>And that’s all for now. As always, hope it is interesting. Please leave a comment below!</p>

  </section>
  <section id="disqus_thread"></section><!-- /#disqus_thread -->
</article>

<div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    /*
    var disqus_config = function () {
        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = 'https://janlauge.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>



      </div>

      <footer class="footer">
  <span class="footer__copyright">&copy; 2018 Laurens Geffert. All rights reserved.</span>
</footer>

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script type="text/javascript" src="js/main.js?1539431935741611000"></script>


    </div>
  </body>
</html>